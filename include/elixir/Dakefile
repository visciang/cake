ARG ELIXIR_VERSION=1.15.6
ARG ELIXIR_ERLANG_VERSION=26.1.1
ARG ELIXIR_ALPINE_VERSION=3.18.2
ARG WORKDIR=/code

elixir.lint: elixir.dialyzer elixir.format elixir.credo

elixir.base:
    FROM docker.io/hexpm/elixir:${ELIXIR_VERSION}-erlang-${ELIXIR_ERLANG_VERSION}-alpine-${ELIXIR_ALPINE_VERSION}
    ARG WORKDIR
    WORKDIR ${WORKDIR}

elixir.toolchain:
    FROM +elixir.base
    RUN apk add --no-cache git build-base
    RUN mix local.rebar --force && \
        mix local.hex --force

elixir.deps:
    FROM +elixir.toolchain
    COPY mix.exs mix.lock* ./
    RUN --mount=type=ssh mix deps.get
    RUN mix deps.get --check-unused
    RUN MIX_ENV=dev mix deps.compile && \
        MIX_ENV=test mix deps.compile

elixir.compile:
    FROM +elixir.deps
    COPY config ./config
    COPY test ./test
    COPY lib ./lib
    COPY .*.exs ./
    RUN MIX_ENV=dev mix compile --warnings-as-errors && \
        MIX_ENV=test mix compile --warnings-as-errors

elixir.dialyzer-plt:
    FROM +elixir.deps
    # dialyzer plt under: _build/dev/dialyxir_*.plt*
    RUN mix dialyzer --plt

elixir.dialyzer:
    FROM +elixir.compile
    ARG WORKDIR
    COPY --from=+elixir.dialyzer-plt ${WORKDIR}/_build/dev/dialyxir_*.plt* ./_build/dev/
    RUN mix dialyzer --no-check

elixir.format:
    FROM +elixir.compile
    RUN mix format --check-formatted

elixir.credo:
    FROM +elixir.compile
    ARG ELIXIR_CREDO_OPTS="--strict --all"
    COPY mix.exs .credo.exs* ./
    RUN mix credo ${ELIXIR_CREDO_OPTS}

@output ${WORKDIR}/cover
elixir.test:
    FROM +elixir.compile
    ARG ELIXIR_TEST_CMD="coveralls.html"
    RUN mix ${ELIXIR_TEST_CMD}

@output ${WORKDIR}/doc
elixir.docs:
    FROM +elixir.compile
    COPY README.md ./
    RUN mix docs --formatter=html

elixir.release:
    FROM +elixir.compile
    RUN mix release --path=_release

elixir.escript-build:
    FROM +elixir.compile
    RUN mix escript.build

elixir.escript:
    FROM +elixir.base
    ARG ESCRIPT_NAME
    ARG WORKDIR
    ARG EXTRA_APK
    RUN apk add --no-cache ${EXTRA_APK}
    COPY --from=+elixir.escript-build ${WORKDIR}/${ESCRIPT_NAME} /app
    ENTRYPOINT [ "/app" ]

@push
elixir.xxx-example-push:
    FROM +elixir.base
    RUN echo "side-effect"

@push
elixir.xxx-example-push2:
    FROM +elixir.base
    RUN echo "side-effect"
